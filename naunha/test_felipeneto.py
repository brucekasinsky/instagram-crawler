#!/usr/bin/env python3
"""
Script de teste para extrair dados do Instagram do Felipe Neto
Testa: login com Instaloader, foto de perfil, dados do perfil, posts e reels
"""

import json
import time
from datetime import datetime
from InstaScraperV2 import ScraperController

def save_to_json(data, filename):
    """Salva dados em arquivo JSON com timestamp"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename_with_timestamp = f"{filename}_{timestamp}.json"
    
    with open(filename_with_timestamp, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    
    print(f"‚úÖ Dados salvos em: {filename_with_timestamp}")
    return filename_with_timestamp

def test_felipeneto_scraping():
    """Testa o scraping completo do perfil do Felipe Neto incluindo reels"""
    
    print("=" * 60)
    print("üöÄ INICIANDO TESTE DE SCRAPING - FELIPE NETO (POSTS + REELS)")
    print("=" * 60)
    
    # Username do Felipe Neto no Instagram
    username = "felipeneto"
    
    # Criar inst√¢ncia do scraper
    scraper = ScraperController()
    
    try:
        # 1. Testar conectividade do proxy
        print("\n1Ô∏è‚É£ Testando conectividade do proxy...")
        if not scraper.test_proxy_connection():
            print("‚ùå Proxy n√£o est√° funcionando! Abortando teste.")
            return False
        print("‚úÖ Proxy funcionando corretamente!")
        
        # 2. Testar proxy do Instaloader
        print("\n2Ô∏è‚É£ Testando proxy do Instaloader...")
        if not scraper.test_instaloader_proxy():
            print("‚ùå Proxy do Instaloader n√£o est√° funcionando! Abortando teste.")
            return False
        print("‚úÖ Proxy do Instaloader funcionando corretamente!")
        
        # 3. Fazer login com Instaloader
        print("\n3Ô∏è‚É£ Fazendo login com Instaloader...")
        if not scraper.login_instaloader():
            print("‚ùå Falha no login com Instaloader! Abortando teste.")
            return False
        print("‚úÖ Login com Instaloader realizado com sucesso!")
        
        # 4. Criar sess√£o do Selenium
        print("\n4Ô∏è‚É£ Criando sess√£o do Selenium...")
        scraper.create_session()
        print("‚úÖ Sess√£o criada com sucesso!")
        
        # 5. Obter foto de perfil
        print(f"\n5Ô∏è‚É£ Obtendo foto de perfil de @{username}...")
        start_time = time.time()
        
        profile_photo_url = scraper.get_profile_photo(username, size=640)
        if profile_photo_url:
            print(f"‚úÖ Foto de perfil obtida: {profile_photo_url}")
            profile_photo_data = {
                "username": username,
                "profile_photo_url": profile_photo_url,
                "timestamp": datetime.now().isoformat()
            }
            save_to_json(profile_photo_data, f"felipeneto_profile_photo")
        else:
            print("‚ùå N√£o foi poss√≠vel obter a foto de perfil")
        
        photo_time = time.time() - start_time
        print(f"‚è±Ô∏è Tempo para obter foto: {photo_time:.2f} segundos")
        
        # 6. Obter dados completos do perfil
        print(f"\n6Ô∏è‚É£ Obtendo dados completos do perfil de @{username}...")
        start_time = time.time()
        
        profile_data = scraper.get_profile_data(username)
        if profile_data:
            print("‚úÖ Dados do perfil obtidos com sucesso!")
            print(f"   üìä Seguidores: {profile_data['followers']:,}")
            print(f"   üìä Seguindo: {profile_data['following']:,}")
            print(f"   üìä Posts: {profile_data['uploads']:,}")
            print(f"   üîí Privado: {'Sim' if profile_data['is_private'] else 'N√£o'}")
            print(f"   ‚úÖ Verificado: {'Sim' if profile_data['is_verified'] else 'N√£o'}")
            
            # Salvar dados do perfil
            save_to_json(profile_data, f"felipeneto_profile_data")
        else:
            print("‚ùå N√£o foi poss√≠vel obter os dados do perfil")
        
        profile_time = time.time() - start_time
        print(f"‚è±Ô∏è Tempo para obter dados do perfil: {profile_time:.2f} segundos")
        
        # 7. Obter posts do perfil
        print(f"\n7Ô∏è‚É£ Obtendo posts de @{username}...")
        start_time = time.time()
        
        posts_data = scraper.get_creator_posts(username)
        if posts_data:
            print(f"‚úÖ {len(posts_data)} posts obtidos com sucesso!")
            
            # Mostrar resumo dos posts
            total_likes = sum(post.get('likes', 0) for post in posts_data)
            total_comments = sum(post.get('comments', 0) for post in posts_data)
            posts_with_hashtags = len([post for post in posts_data if post.get('hashtags')])
            posts_with_tags = len([post for post in posts_data if post.get('tags')])
            
            print(f"   üìä Total de likes: {total_likes:,}")
            print(f"   üìä Total de coment√°rios: {total_comments:,}")
            print(f"   üìä Posts com hashtags: {posts_with_hashtags}")
            print(f"   üìä Posts com tags: {posts_with_tags}")
            
            # Mostrar alguns exemplos de posts
            print("\n   üìù Exemplos de posts:")
            for i, post in enumerate(posts_data[:3]):
                print(f"      Post {i+1}:")
                print(f"         URL: {post.get('post_url', 'N/A')}")
                print(f"         Likes: {post.get('likes', 0):,}")
                print(f"         Coment√°rios: {post.get('comments', 0):,}")
                if post.get('hashtags'):
                    print(f"         Hashtags: {', '.join(post['hashtags'][:3])}")
                if post.get('post_text'):
                    text_preview = post['post_text'][:100] + "..." if len(post['post_text']) > 100 else post['post_text']
                    print(f"         Texto: {text_preview}")
                print()
            
            # Salvar dados dos posts
            save_to_json(posts_data, f"felipeneto_posts")
        else:
            print("‚ùå N√£o foi poss√≠vel obter os posts")
        
        posts_time = time.time() - start_time
        print(f"‚è±Ô∏è Tempo para obter posts: {posts_time:.2f} segundos")
        
        # 8. Obter reels do perfil usando Instaloader
        print(f"\n8Ô∏è‚É£ Obtendo reels de @{username} usando Instaloader...")
        start_time = time.time()
        
        reels_data = scraper.get_creator_reels_instaloader(username, max_count=20)
        if reels_data:
            print(f"‚úÖ {len(reels_data)} reels obtidos com sucesso!")
            
            # Mostrar resumo dos reels
            total_reel_likes = sum(reel.get('likes', 0) for reel in reels_data)
            total_reel_comments = sum(reel.get('comments', 0) for reel in reels_data)
            total_reel_views = sum(reel.get('views', 0) for reel in reels_data)
            reels_with_hashtags = len([reel for reel in reels_data if reel.get('hashtags')])
            
            print(f"   üìä Total de likes nos reels: {total_reel_likes:,}")
            print(f"   üìä Total de coment√°rios nos reels: {total_reel_comments:,}")
            print(f"   üìä Total de visualiza√ß√µes nos reels: {total_reel_views:,}")
            print(f"   üìä Reels com hashtags: {reels_with_hashtags}")
            
            # Mostrar alguns exemplos de reels
            print("\n   üé¨ Exemplos de reels:")
            for i, reel in enumerate(reels_data[:3]):
                print(f"      Reel {i+1}:")
                print(f"         URL: {reel.get('reel_url', 'N/A')}")
                print(f"         Likes: {reel.get('likes', 0):,}")
                print(f"         Coment√°rios: {reel.get('comments', 0):,}")
                print(f"         Visualiza√ß√µes: {reel.get('views', 0):,}")
                print(f"         Dura√ß√£o: {reel.get('duration', 0):.1f}s")
                if reel.get('hashtags'):
                    print(f"         Hashtags: {', '.join(reel['hashtags'][:3])}")
                if reel.get('caption'):
                    caption_preview = reel['caption'][:100] + "..." if len(reel['caption']) > 100 else reel['caption']
                    print(f"         Legenda: {caption_preview}")
                print()
            
            # Salvar dados dos reels
            save_to_json(reels_data, f"felipeneto_reels")
        else:
            print("‚ùå N√£o foi poss√≠vel obter os reels")
        
        reels_time = time.time() - start_time
        print(f"‚è±Ô∏è Tempo para obter reels: {reels_time:.2f} segundos")
        
        # 9. Resumo final
        print("\n" + "=" * 60)
        print("üìã RESUMO DO TESTE")
        print("=" * 60)
        print(f"‚úÖ Proxy: Funcionando")
        print(f"‚úÖ Proxy Instaloader: Funcionando")
        print(f"‚úÖ Login Instaloader: Realizado")
        print(f"‚úÖ Sess√£o Selenium: Criada")
        print(f"‚úÖ Foto de perfil: {'Obtida' if profile_photo_url else 'Falhou'}")
        print(f"‚úÖ Dados do perfil: {'Obtidos' if profile_data else 'Falharam'}")
        print(f"‚úÖ Posts: {'Obtidos' if posts_data else 'Falharam'}")
        print(f"‚úÖ Reels: {'Obtidos' if reels_data else 'Falharam'}")
        
        if profile_data:
            print(f"\nüìä DADOS DO PERFIL:")
            print(f"   Username: @{profile_data['username']}")
            print(f"   Nome: {profile_data['full_name']}")
            print(f"   Seguidores: {profile_data['followers']:,}")
            print(f"   Seguindo: {profile_data['following']:,}")
            print(f"   Posts: {profile_data['uploads']:,}")
            print(f"   Bio: {profile_data['description'][:100]}..." if profile_data['description'] else "   Bio: Sem descri√ß√£o")
        
        if posts_data:
            print(f"\nüìä DADOS DOS POSTS:")
            print(f"   Total de posts: {len(posts_data)}")
            print(f"   Total de likes: {sum(post.get('likes', 0) for post in posts_data):,}")
            print(f"   Total de coment√°rios: {sum(post.get('comments', 0) for post in posts_data):,}")
        
        if reels_data:
            print(f"\nüé¨ DADOS DOS REELS:")
            print(f"   Total de reels: {len(reels_data)}")
            print(f"   Total de likes: {sum(reel.get('likes', 0) for reel in reels_data):,}")
            print(f"   Total de coment√°rios: {sum(reel.get('comments', 0) for reel in reels_data):,}")
            print(f"   Total de visualiza√ß√µes: {sum(reel.get('views', 0) for reel in reels_data):,}")
        
        print("\nüéâ TESTE CONCLU√çDO COM SUCESSO!")
        
        return True
        
    except Exception as e:
        print(f"\n‚ùå ERRO durante o teste: {str(e)}")
        import traceback
        traceback.print_exc()
        return False
        
    finally:
        # Sempre fechar a sess√£o
        try:
            scraper.quit_session()
            print("\nüîí Sess√£o fechada com sucesso!")
        except:
            pass

def main():
    """Fun√ß√£o principal"""
    print("ü§ñ Teste de Scraping do Instagram - Felipe Neto (Posts + Reels)")
    print("üìÖ Data/Hora:", datetime.now().strftime("%d/%m/%Y %H:%M:%S"))
    
    # Executar teste
    success = test_felipeneto_scraping()
    
    if success:
        print("\n‚úÖ Todos os testes passaram!")
        print("üìÅ Verifique os arquivos JSON gerados para os dados extra√≠dos.")
    else:
        print("\n‚ùå Alguns testes falharam!")
        print("üîç Verifique os logs acima para mais detalhes.")

if __name__ == "__main__":
    main()




